# MPMC Цикрулярний буфер

## Проблема

Припустимо, ви хочете зробити багатопотоковий додаток. Одна з найскладніших проблем на вашому шляху - як переконатися в тому, що класи з різних потоків не зчитують і записують значення в ту саму ділянку пам'яті (змінну) одночасно. Вирішень цієї проблеми багато - починаючи від примітивів синхронізації (lock, mutex, semaphore, etc.), рясно доданих до коду класів, до яких може бути отриманий доступ з різних потоків, до stateless класів, lock-free алгоритмів та ін.

Одне з простих і тим не менш ефективних рішень, що використовуються в розподілених системах, заснованих на системі Actor'ів, є принцип відправлення повідомлень: нехай цільовий клас обробляється одним потоком, а інші взаємодіють з ним шляхом відправлення та прийому повідомлень. Мінімум lock'ів, мінімум роботи з переведення однопотокового додатка на багатопотокове. Однак виникає нова проблема: система передачі та прийому повідомлень, що працює з безліччю потоків - як записуючих, так і читаючих.

## Рішення

У світі embedded розробки вже давно винайдено рішення, що задовольняє цю вимогу, тому що там нерідко трапляється ситуація, коли модулі, що обмінюються повідомленнями, працюють з різною швидкістю (наприклад, CPU працює швидше, ніж якийсь датчик) і, відповідно, один повинен чекати поки другий закінчить запис стану, з яким можна працювати - циркулярні буфери.

Multiple Producers Multiple Consumers (MPMC) циркулярний буфер вже давно використовують у двигунах ААА-ігор для досягнення взаємодії між системами програми, що працюють у різних потоках, та для потокобезпечного обміну повідомленнями.

### Класи

* `EBufferElementState`

Enum. Вказує статус чарунки циркулярного буфера. VACANT - порожня, доступна для запису, ALLOCATED_FOR_PRODUCER - алокована під запис, заповнюється, FILLED - записана, доступна для читання, ALLOCATED_FOR_CONSUMER - алокована під читання, зчитується.

* `ConcurrentGenericCircularBuffer`

MPMC Циркулярний буфер. Надає методи `GetState(int index)`, що повертає стан чарунки буфера за індексом, `TryProduce(TValue value)`, який виконує спробу запису в буфер, та `TryConsume(out TValue value)`, що виконує спробу вважати значення з буфера